<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Web Scanner â€” Compat (PDF417 & Data Matrix)</title>
    <style>
        body {
            margin: 0;
            background: #0b0c10;
            color: #e8f0fe;
            font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif
        }

        .wrap {
            max-width: 900px;
            margin: 0 auto;
            padding: 16px
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center
        }

        .panel {
            background: #13141a;
            border: 1px solid #202431;
            border-radius: 14px;
            padding: 14px
        }

        video {
            width: 100%;
            background: #000;
            border-radius: 14px;
            border: 1px solid #202431
        }

        .btn {
            appearance: none;
            border: 0;
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 600
        }

            .btn.primary {
                background: #2a6cff;
                color: #fff
            }

            .btn.danger {
                background: #aa2d2d;
                color: #fff
            }

        select, input {
            background: #0f1117;
            border: 1px solid #202431;
            color: #e8f0fe;
            border-radius: 8px;
            padding: 8px
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            white-space: pre-wrap;
            word-break: break-word
        }

        .status {
            font-size: 13px;
            color: #aeb8cc
        }
    </style>
</head>
<body>
    <div class="wrap">
        <h1>ðŸ“· Web Scanner â€” Compatibility build</h1>

        <div class="panel">
            <div class="row">
                <button id="btnPerms" class="btn">Request Camera Permission</button>
                <select id="cameraSel"></select>
                <button id="btnStart" class="btn primary">Start Camera</button>
                <button id="btnStop" class="btn danger" disabled>Stop</button>
            </div>
            <div class="status" id="status">Idle</div>
        </div>

        <video id="video" playsinline muted></video>

        <div class="panel" style="margin-top:12px">
            <div class="mono" id="out" style="min-height:100px"></div>
        </div>
    </div>

    <!-- UMD builds (no modules) -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest"></script>
    <script>
        (function () {
            const out = document.getElementById('out');
            const statusEl = document.getElementById('status');
            const video = document.getElementById('video');
            const cameraSel = document.getElementById('cameraSel');
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            const btnPerms = document.getElementById('btnPerms');

            let reader = null;
            let controls = null;

            function setStatus(s) { statusEl.textContent = s; }

            async function requestPerms() {
                try {
                    setStatus('Requesting camera permissionâ€¦');
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    // stop right away; we just wanted the prompt
                    stream.getTracks().forEach(t => t.stop());
                    setStatus('Permission granted. Choose camera & Start.');
                    await listCameras();
                } catch (e) {
                    setStatus('Permission failed: ' + (e && e.message ? e.message : e));
                    alert('Camera permission is required. Check Settings > Safari > Camera: Allow.');
                }
            }

            async function listCameras() {
                try {
                    const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
                    cameraSel.innerHTML = '';
                    devices.forEach((d, i) => {
                        const opt = document.createElement('option');
                        opt.value = d.deviceId; opt.textContent = d.label || ('Camera ' + (i + 1));
                        cameraSel.appendChild(opt);
                    });
                    if (devices.length > 1) { cameraSel.selectedIndex = devices.length - 1; } // prefer rear
                } catch (e) {
                    setStatus('List cameras error: ' + (e.message || e));
                }
            }

            async function start() {
                try {
                    btnStart.disabled = true; btnStop.disabled = false;
                    setStatus('Startingâ€¦');
                    reader = new ZXing.BrowserMultiFormatReader();
                    const hints = new Map();
                    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.PDF_417, ZXing.BarcodeFormat.DATA_MATRIX]);
                    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                    reader.hints = hints;

                    const devId = cameraSel.value || (await ZXing.BrowserMultiFormatReader.listVideoInputDevices())[0]?.deviceId;
                    controls = await reader.decodeFromVideoDevice(devId, video, (result, err) => {
                        if (result) {
                            out.textContent = 'Format: ' + result.getBarcodeFormat() + '\n\n' + result.getText();
                            setStatus('Decoded âœ“');
                        } else if (err && !(err instanceof ZXing.NotFoundException)) {
                            setStatus('Decode error: ' + (err.message || err));
                        }
                    });
                    setStatus('Live');
                } catch (e) {
                    setStatus('Start error: ' + (e.message || e));
                    alert('Start error: ' + (e.message || e));
                    btnStart.disabled = false; btnStop.disabled = true;
                }
            }

            async function stop() {
                try {
                    btnStart.disabled = false; btnStop.disabled = true;
                    setStatus('Stoppingâ€¦');
                    if (controls) { controls.stop(); controls = null; }
                    if (reader) { await reader.reset(); reader = null; }
                    setStatus('Stopped');
                } catch (e) {
                    setStatus('Stop error: ' + (e.message || e));
                }
            }

            btnPerms.addEventListener('click', requestPerms);
            btnStart.addEventListener('click', start);
            btnStop.addEventListener('click', stop);

            // On load, try to populate camera list
            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                listCameras();
            } else {
                setStatus('Camera API not supported in this browser.');
            }
        })();
    </script>
</body>
</html>
